services:
  # Database Services
  postgres:
    image: pgvector/pgvector:pg16
    container_name: flynn-aac-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: flynn_aac
    ports:
      - "5434:5432"  # External 5434 to avoid conflict with host postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flynn-aac-network

  postgres-test:
    image: pgvector/pgvector:pg16
    container_name: flynn-aac-postgres-test
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: flynn_aac_test
    ports:
      - "5433:5432"
    # No volume - ephemeral for tests
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flynn-aac-network

  redis:
    image: redis:7-alpine
    container_name: flynn-aac-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flynn-aac-network

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: flynn-aac-backend
    environment:
      NODE_ENV: development
      PORT: 3000
      LOG_LEVEL: debug
      DATABASE_URL: postgres://postgres:postgres@postgres:5432/flynn_aac
      REDIS_URL: redis://redis:6379
      CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY:-}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY:-}
      CLERK_WEBHOOK_SECRET: ${CLERK_WEBHOOK_SECRET:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      LINEAR_API_KEY: ${LINEAR_API_KEY:-}
    ports:
      - "3000:3000"
    volumes:
      - ./backend/src:/app/src:ro
      - ./backend/drizzle:/app/drizzle:ro
      - backend_node_modules:/app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - flynn-aac-network
    restart: unless-stopped

  # Caregiver Web Portal
  caregiver-web:
    build:
      context: ./caregiver-web
      dockerfile: Dockerfile
      target: development
    container_name: flynn-aac-caregiver-web
    environment:
      VITE_API_URL: http://localhost:3000/api/v1
      VITE_CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY:-}
    ports:
      - "3001:3001"
    volumes:
      - ./caregiver-web/src:/app/src:ro
      - ./caregiver-web/app:/app/app:ro
      - ./caregiver-web/public:/app/public:ro
      - caregiver_node_modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - flynn-aac-network
    restart: unless-stopped

  # Therapist Web Portal
  therapist-web:
    build:
      context: ./therapist-web
      dockerfile: Dockerfile
      target: development
    container_name: flynn-aac-therapist-web
    environment:
      VITE_API_URL: http://localhost:3000/api/v1
      VITE_CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY:-}
    ports:
      - "3002:3002"
    volumes:
      - ./therapist-web/src:/app/src:ro
      - ./therapist-web/public:/app/public:ro
      - therapist_node_modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - flynn-aac-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  backend_node_modules:
  caregiver_node_modules:
  therapist_node_modules:

networks:
  flynn-aac-network:
    driver: bridge
